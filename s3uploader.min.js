class S3Uploader{constructor(){this._handleTotalProgress=this.throttle(this._handleTotalProgress.bind(this),160)}async init(t){if(this.files=[],this.pack=[],this.uploaded=[],this.skipped=[],this.failed=[],this.listeners={},this.filesUploadProgressData=[],this.done=0,this.totalSize=0,this.accumulatedSize=0,this.options=t,this.options.maxWidth||(this.options.maxWidth=4e3),this.options.maxHeight||(this.options.maxHeight=4e3),this.options.maxPicFileSize||(this.options.maxPicFileSize=6999e3),this.options.maxVidFileSize||(this.options.maxVidFileSize=9999e3),this.options.addS3inputs){if(!this.options.credentialsEndPoint)throw new Error("Missing credential endpoint");try{let t=await this._getFormInputs();this.options.formInputs={},this.options.formInputs.policy=t.inputsValues.policy,this.options.formInputs.credential=t.inputsValues["X-amz-credential"],this.options.formInputs.algorithm=t.inputsValues["X-amz-algorithm"],this.options.formInputs.x_amz_date=t.inputsValues["X-amz-date"],this.options.formInputs.signature=t.inputsValues["X-amz-signature"],this.options.formInputs.expires=t.inputsValues.Expires,this.options.formInputs.cacheControl=t.inputsValues.CacheControl,this.options.formInputs.url=decodeURIComponent(t.formUrl),this.options.formInputs.tenantDir=t.directory,this.options.directory=[t.directory]}catch(t){throw new Error(t)}}else{if(!this.options.uploadUrl)throw new Error("Missing upload URL (uploadUrl)");this.options.formInputs={url:decodeURIComponent(this.options.uploadUrl)},this.options.prefix&&(this.options.directory=[this.options.prefix])}}addFile(t){this.files.push(t)}addEventListener(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}removeEventListener(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter((t=>t!==e)))}async start_upload(){this._dispatchEvent("upload_start",this.files.length);for(const[t,e]of this.files.entries()){let i=await this._processFile(e);"object"==typeof i&&this.pack.push(i),this._dispatchEvent("pre-process",{file:i,processed:t,total:this.files.length})}this._manageTransfers()}async _processFile(t){try{if(!this._checkFileSize(t)){let e={message:"file size too large",size:t.size,name:t.name};return this.skipped.push(e),this._dispatchEvent("skip-file",e),this._reportDone(),!1}let e=await this._getFileInfo(t),i=this._rename(t.name),s=await this._fixImageSize(t);return e.size=s.size,this.accumulatedSize+=s.size,{oldFileName:t.name,fileSize:s.size,fileType:t.type,newFileName:i,metadata:e,fixed_file:s}}catch(t){return this._dispatchEvent("error",t),!1}}async _manageTransfers(){let t=navigator.hardwareConcurrency||4,e=this.pack,i=[];for(var s=0,o=0;e.length>0||i.length>0;){for(;e.length>0&&i.length<t;){let t=e.shift();i.push({id:s,prom:this._transferFile(t)}),s++}let a=await Promise.race(i);if(i=i.filter((t=>t.id!=a.id)),o>=this.files.length+30)return;o++}}async _transferFile(t){let e=await this._doXHRupload(t),i={metadata:t.metadata,location:e.location,size:e.size};this._dispatchEvent("completion",i),this.uploaded.push(i),this._reportDone()}async _doXHRupload(t){return new Promise(((e,i)=>{let s=new XMLHttpRequest,o=new FormData;o.append("key",t.newFileName),o.append("Content-Type",t.fileType),o.append("acl","public-read"),o.append("success_action_status",201),this.options.addS3inputs&&(o.append("policy",this.options.formInputs.policy),o.append("X-amz-credential",this.options.formInputs.credential),o.append("X-amz-algorithm",this.options.formInputs.algorithm),o.append("X-amz-date",this.options.formInputs.x_amz_date),o.append("X-amz-signature",this.options.formInputs.signature),o.append("Expires",this.options.formInputs.expires),o.append("CacheControl",this.options.formInputs.cacheControl)),o.append("file",t.fixed_file),s.open("POST",this.options.formInputs.url);let a={size:t.fileSize,uploaded:0,totalSize:0};this.filesUploadProgressData.push(a);let n=0;s.upload.onprogress=t=>{t.lengthComputable&&(a.uploaded=t.loaded,a.totalSize=t.total,n=t.total,this._handleTotalProgress())},s.onreadystatechange=()=>{if(4===s.readyState)if(201===s.status){let t=(new window.DOMParser).parseFromString(s.response,"text/xml").documentElement.childNodes[0].textContent.replace(/%2F/g,"/");e({location:t,size:n})}else this.failed.push({message:s.response,size:t.fileSize,name:t.oldFileName}),this._dispatchEvent("error",s.response),i(s.response)},s.onerror=e=>{this.failed.push({message:e,size:t.fileSize,name:t.oldFileName}),i(e)},s.send(o)}))}async _getFileInfo(t){let e;return t.type.startsWith("image/")?e=await this._extractMetadata(t):t.type.startsWith("video/")&&(e=await this._extractVideoInfo(t)),e}async _fixImageSize(t){if(t.type.startsWith("image/")){let e=await this._createImage(t),{width:i,height:s}=e;if(i>this.options.maxWidth||s>this.options.maxHeight){let o=document.createElement("canvas"),a=o.getContext("2d");a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high";let n=this._resolveSize(i,s);o.width=n.width,o.height=n.height,a.drawImage(e,0,0,i,s,0,0,o.width,o.height),t=this._dataURItoBlob(o.toDataURL("image/jpeg")),o=null}}return t}async _createImage(t){return new Promise(((e,i)=>{let s=new Image;s.onload=()=>{e(s)},s.onerror=t=>{i(t)},s.src=URL.createObjectURL(t)}))}async _getFormInputs(){let t=await fetch(this.options.credentialsEndPoint,{method:"post",mode:"same-origin",headers:{"Content-Type":"application/json;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({method:"getUploadFormInputs"})});return await t.json()}_handleTotalProgress(){let t=0,e=0;this.filesUploadProgressData.forEach((i=>{e+=i.totalSize,t+=i.uploaded})),this.totalSize=e,this._dispatchEvent("total-progress",{progress:Math.floor(t/this.accumulatedSize*100),totalFiles:this.files.length,uploaded:this.done})}_reportDone(){this.done++,this.done>=this.files.length&&this._dispatchEvent("upload-done",{uploaded:this.uploaded.length,totalSize:this.totalSize,uploadedFiles:this.uploaded,skipped:this.skipped,failed:this.failed})}_dataURItoBlob(t){let e=atob(t.split(",")[1]),i=t.split(",")[0].split(":")[1].split(";")[0],s=new ArrayBuffer(e.length),o=new Uint8Array(s);for(let t=0;t<e.length;t++)o[t]=e.charCodeAt(t);return new Blob([s],{type:i})}_rename(t){let e=this._fixFileName(t),i=this.options.directory,s=Date.now();return`${i.length?i.join("/")+"/":""}${s}_${e}`}_fixFileName(t){let e,i="jpg",s=t.split(".");return s.length>1?(i=s.pop().toLowerCase().slice(0,4),i.length>4&&(i="jpg"),e=s.join()):e=t,e=e.replace(/[^\w\- ]+/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^[-_]+|[-_]+$/g,""),e.length<3&&(e+="pic_"+(Math.random()+1).toString(36).substring(4,10)),`${e}.${i}`}_checkFileSize(t){return t.type.startsWith("image/")?t.size<this.options.maxPicFileSize:!!t.type.startsWith("video/")&&t.size<this.options.maxVidFileSize}_resolveSize(t,e){let i=t,s=e,o=i/s;return t>this.options.maxWidth&&(i=this.options.maxWidth,s=Math.floor(i/o)),s>this.options.maxHeight&&(s=this.options.maxHeight,i=Math.floor(s*o)),{width:i,height:s}}_dispatchEvent(t,e){this.listeners[t]&&this.listeners[t].forEach((t=>t(e)))}_extractMetadata(t){var e=this;return new Promise(((i,s)=>{var o=new FileReader;o.onload=function(t){var s={};try{let e=ExifReader.load(t.target.result);delete e.MakerNote,s={city:e.City?.description,country:e.Country?.description??e.State?.description,natWidth:e.ImageWidth?.description,natHeight:e.ImageLength?.description,description:e.ImageDescription?.description??e["Caption/Abstract"]?.description??e.description?.description,keywords:e.subject?.description??e.Keywords?.map((t=>t.description))?.join(",")}}catch(t){}var o=new Image;let a=window.URL||window.webkitURL,n=new Blob([t.target.result],{type:"image/jpeg"});o.src=a.createObjectURL(n),o.onload=function(){let t=e._resolveSize(this.width,this.height);s.width=t.width,s.height=t.height,i(s)}},o.onerror=function(t){s({status:"fail",message:t})},o.readAsArrayBuffer(t)}))}_extractVideoInfo(t){return new Promise(((e,i)=>{const s=document.createElement("video");s.preload="metadata",s.src=URL.createObjectURL(t),s.onloadedmetadata=()=>{window.URL.revokeObjectURL(s.src);let i=s.videoWidth,o=s.videoHeight,a=s.duration;e({width:i,height:o,size:t.size,duration:a})},s.onerror=i}))}throttle(t,e){var i=!1;return function(){i||(t.call(),i=!0,setTimeout((function(){i=!1}),e))}}}